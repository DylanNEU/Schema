{% extends 'base.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/address.css' %}">
      <link href="{% static 'css/enter_form.css' %}" rel="stylesheet">

    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=2.0&ak=h40MTWwwSpgwCUEw8MbIiBnc3X4keNgX"></script>
    <script type="text/javascript" src="{% static 'js/3.1.1/layer.js' %}"></script>
{% endblock %}
{% block title %}主页{% endblock %}
{% block content %}


    <div id="enter_form" style="display: none">
    <img src="" id="show_img" style="width: 250px;margin-left: 15px">
   <form  action="" method="post" enctype="multipart/form-data" id="form" class="smart-green" >
{% csrf_token %}
    <input type="file"  name="up_file" id="up_file"  onchange="checkFileExt(this.value)">
               <div id = "up_file_error" class="error-msg" style="font-weight: bold"></div>
<label id="video_url_block" style="display: none"><span>视频网址 :</span>
        <input id="video_url"  type="text" name="video_url"  />
        <div id = "video_url_error" class="error-msg" ></div>
    </label>
       <label><span>建筑名称 :</span>
        <input id="building_name"  type="text" name="building_name"  />
        <div id = "building_name_error" class="error-msg" ></div>
    </label>
    <label><span>原始标题 :</span>
        <input id="title"  type="text" name="title"  />
        <div id = "title_error" class="error-msg"></div>
    </label>
       <label><span>拍摄者 :</span>
        <input id="creator" type="text" name="creator"  />
        <div id = "creator_error" class="error-msg"></div>
    </label>
       <label><p>拍摄时间 :</p>
           <div style="border:1px solid #9b9b9b;border-radius: 3px;width: 115px;display: inline-block">
        <input id="cre_date_year"  type="text" placeholder="年" name="cre_date_year"  style="display: inline-block;width: 45px;border-radius: 3px"/>
       <input id="cre_date_month"  type="text" placeholder="月" name="cre_date_month"  style="display: inline-block;width: 30px;border-radius: 3px"/>
       <input id="cre_date_day"  type="text" placeholder="日"  name="cre_date_day"  style="display: inline-block;width: 30px;border-radius: 3px"/>
           </div>
           <div style="display:inline-block;"> <p style="display: inline-block;margin-left: 5px;margin-right: 5px;font-size: 15px">or</p></div>
<input id="cre_date_str"  type="text" placeholder="例如:“明国时期”"  name="cre_date_str"  style="height:35px;display: inline-block;width: 150px;border-radius: 3px"/>
        <div id = "cre_date_error" class="error-msg"></div>
    </label>
       <label><span>地理位置 :</span>
        <input id="location" type="text" name="location"  />
        <div id = "location_error" class="error-msg"></div>
    </label>
       <label ><span id="description_value"></span>
        <textarea id="file_description"  name="file_description"></textarea>
        <div id = "file_description_error" class="error-msg"></div>
    </label>
    <label id="encodetype_value_block" ><span id="encodetype_value"></span>
        <input id="encode_type"  type="text" name="encode_type"/>
        <div class="error-msg"></div>
    </label>
       <label><span> 建筑现状:</span>
        <textarea id="building_information"  name="building_information"></textarea>
        <div id = "building_information_error" class="error-msg"></div>
    </label>
       <label><span> 发布者:</span>
        <input id="announcer" type="text" name="announcer"  />
        <div class="error-msg"></div>
    </label>
       <label><span> 版权人:</span>
        <input id="CopyrightOwner" type="text" name="CopyrightOwner"  />
        <div class="error-msg"></div>
    </label>
       <label ><span id="source_value"></span>
        <input id="file_citation" type="text" name="file_citation"  />
        <div class="error-msg"></div>
    </label>
       <label><span> 分类:</span>
        <input id="type" type="text" name="type" placeholder="可填多个标签(以空格分隔)" />
        <div class="error-msg"></div>
    </label>
    <div class="success-msg"></div>
    <input type="hidden" name="csrfmiddlewaretoken" value="SfHkbL4feo1G00sJQtbO7TtLN4c2BUwa" />
</form>
</div>
<form action="" method="get">
<div id="search_block">
  <label style="margin-left: 10px;color: white">地点：</label>
  <input id="where" style="width: 300px;margin-top: 8px;margin-bottom: 5px";name="where" type="text" >
  <input type="button" value="地图上找"  style="margin-right: 10px;" onClick="sear(document.getElementById('where').value);" />
    <button style="position:absolute;right: 0;width: 80px;margin-top: 8px;margin-right: 15px" onClick="javascript:window.history.back();return false;"><img src="../../../static/imgs/back.png" style="height: 20px"></button>

</div>
  <div style="border:1px solid gray;" id="allmap"></div>  <br />
        <p style="color: #304d5e;font-size: 12px;margin-left: 5px">红色五角星:&nbsp;您本人创建的标注点;<br>黄色五角星:&nbsp;其他用户创建的标注点;</p>
</form>
<script type="text/javascript">
    // 百度地图API功能
       // 百度地图API功能
    var type_arr = [];
    var showflag=false;
    var marker;
    var time = 0;
    var bjh = $("input[name='bjh']").val();
    var sx = $("input[name='sx']").val();
    var sqr = $("input[name='sqr']").val();
    var pointX;
    var pointY;
    var marker_type;

     var map = new BMap.Map("allmap" ,{ enableMapClick: false }); // 创建Map实例

map.setDefaultCursor("crosshair");
    map.centerAndZoom(new BMap.Point(123.471095,41.68383), 15); // 初始化地图,设置中心点坐标和地图级别,****代表经纬度，可以通过http://api.map.baidu.com/lbsapi/creatmap/ 来查看你需要的城市的经纬度

    //添加地图类型控件
    map.addControl(new BMap.MapTypeControl({
        mapTypes : [ BMAP_NORMAL_MAP, BMAP_HYBRID_MAP ]
    }));
    map.setCurrentCity("沈阳"); // 设置地图显示的城市 此项是必须设置的
    map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
    //点击地图并在此添加标记
    //向地图中添加缩放控件
    var ctrlNav = new window.BMap.NavigationControl({
        anchor: BMAP_ANCHOR_TOP_LEFT,
        type: BMAP_NAVIGATION_CONTROL_LARGE
    });
    map.addControl(ctrlNav);
    //向地图中添加缩略图控件
    var ctrlOve = new window.BMap.OverviewMapControl({
        anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
        isOpen: 1
    });
    map.addControl(ctrlOve);
    //向地图中添加比例尺控件
    var ctrlSca = new window.BMap.ScaleControl({
        anchor: BMAP_ANCHOR_BOTTOM_LEFT
    });
    map.addControl(ctrlSca);
    map.addEventListener("click", function(e) {//鼠标单击地图触发
        if (time >= 1) {
            return;
        } else {
            choose_form(e);
        }
    });
$(function() {
        $('#li-2').addClass("active");
        var winWidth,winHeight=0;
        var map_block = document.getElementById('allmap');
        if (window.innerWidth)
        winWidth = window.innerWidth;
        else if ((document.body) && (document.body.clientWidth))
        winWidth = document.body.clientWidth;
        //获取窗口高度
        if (window.innerHeight)
        winHeight = window.innerHeight;
        else if ((document.body) && (document.body.clientHeight))
        winHeight = document.body.clientHeight;
        //通过深入Document内部对body进行检测，获取窗口大小
        if (document.documentElement  && document.documentElement.clientHeight && document.documentElement.clientWidth)
        {
        winHeight = document.documentElement.clientHeight;
        winWidth = document.documentElement.clientWidth;
        }
        map_block.style.height = winHeight*2/3 + 'px';
        map_block.style.width = winWidth + 'px';
        get_location();
        })
     function get_location() {
    var post_data = "";
    var receive_data="";
    var address_latitude ="";
    var address_longitude ="";
    var address_data ="";
        $.ajax({
                url: '/map/get_points/',
                type: "POST",
                data: post_data,
                success: function (data) {
                    receive_data = JSON.parse(data);
                    address_latitude =receive_data["address_latitude"];
        address_longitude =receive_data["address_longitude"];
        address_data =receive_data["address_data"];
        console.log(receive_data)
        var point;
                for (var i = 0; i < address_longitude.length; i++) {
            point = new BMap.Point(parseFloat(address_longitude[i]), parseFloat(address_latitude[i])); //循环生成新的地图点
            createMarker(point,address_data[i])
        }
        map.centerAndZoom(point, 15);


                },
                error:function () {
               $.ShowLoadDialogClose();
                  alert("获取失败！")
                }
             });

    }
function createMarker(point,point_data) {
    user_id = {{ request.session.user_id }}
    var marker = new BMap.Marker(point, {
  // 初始化五角星symbol
  icon: new BMap.Symbol(BMap_Symbol_SHAPE_STAR, {
    scale: 1,
    fillColor: "yellow",
    fillOpacity: 0.8
  })
});
    if(user_id == point_data["monitor_id"])
    {
        marker = new BMap.Marker(point, {
  // 初始化五角星symbol
  icon: new BMap.Symbol(BMap_Symbol_SHAPE_STAR, {
    scale: 1,
    fillColor: "red",
    fillOpacity: 0.8
  })
});
    }

    map.addOverlay(marker);
    marker.addEventListener('click', function () {
        showInfo(this,point_data);
    });
}

    function display_date(pointInfo_datestr, type) {
        if(type == 0)
        {
            $('#cre_date_str').val(pointInfo_datestr);
            $('#cre_date_str').css("background","#e8f0fe");
        }
        else if(type==1)
        {
            pointInfo_datestr = pointInfo_datestr.replace('#',"");
            var reg = new RegExp("[年月日]","g");
            var temp_str = pointInfo_datestr.replace(reg,"|");
            var str_list = temp_str.substring(0,temp_str.length-1).split('|');
            $('#cre_date_year').val(str_list[0]);
            $('#cre_date_year').css("background","#e8f0fe");
            if(str_list.length>1)
            {$('#cre_date_month').val(str_list[1]);
            $('#cre_date_month').css("background","#e8f0fe");}
            if(str_list.length>2)
            {$('#cre_date_day').val(str_list[2]);
            $('#cre_date_day').css("background","#e8f0fe");}
        }
    }
function clear_form() {
    $("#form").find("input").removeAttr("readonly");
    $("#form").find("textarea").removeAttr("readonly");
    document.getElementById('form').reset();
    $("input").css('background',"#FBFBFB");
    $("textarea").css('background',"#FBFBFB");
    $('.error-msg').html('');
    $("#show_img").attr("src","");
}
    function showInfo(thisMarker,point_info) {
    clear_form()
    user_id = {{ request.session.user_id }}
    user_role  = '{{ request.session.role }}';
    showflag=true;
    console.log(point_info["node_id"])
    for(var i in point_info)
    {
        var str=point_info[i][0];
        if(i == "building_name")
        {
            str=str.slice(0,-2);
            $('#'+i).val(str);
            if(str!="")$('#'+i).css("background","#e8f0fe");
        }
        else if(i == "cre_date")
        {
            if(point_info[i].length>1)
            {
                display_date(point_info[i][0],0);
                display_date(point_info[i][1],1);
            }
            else
            {
                if(point_info[i][0].charAt(point_info[i][0].length-1)=='#')
                {
                    display_date(point_info[i][0],1);
                }
                else
                {
                    display_date(point_info[i][0],0);
                }
            }
        }
        else
        {
            for(var j=1;j<point_info[i].length;j++)
            {
                str = str + " " + point_info[i][j];
            }
            $('#'+i).val(str);
            if(str!="")$('#'+i).css("background","#e8f0fe");
        }


    }
    if (point_info["marker_type"]=='1')
    {
        image_show()
        $('#up_file').css("display","none");
        $("#show_img").attr("src","..\\..\\..\\"+point_info["mediaObject"][0]);
    }
    else if(point_info["marker_type"]=='2')
    {
        video_show()
        $("#video_url").val(point_info["mediaObject"]);
        $("#video_url").css("background","#e8f0fe");
    }
    if(user_id == point_info["monitor_id"] || user_role == "A")
    {
        var index = layer.open({
    type: 1,
    title: '标注信息',
    area: ['350px', '550px'],
    shadeClose: true, //点击遮罩关闭
    content: $('#enter_form'),
     btn:['删除该标注点'],
     btn1:function () {
            var post_data ={ "node_id":point_info["node_id"]};
            console.log(post_data)
        $.ajax({
                url: '/map/delete_point/',
                type: "POST",
                data: post_data,
                async: true,
                success: function (data) {
                    layer.alert("已删除！")
                    map.removeOverlay(thisMarker);
                    layer.close(index);
                },
                error:function () {
                  layer.alert("删除失败！")
                }
             });
     }
  });

    }
    else
    {
        $("#form").find("input").attr("readonly","readonly");
        $("#form").find("textarea").attr("readonly","readonly");
     var index = layer.open({
    type: 1,
    title: '标注信息',
    area: ['350px', '550px'],
    shadeClose: true, //点击遮罩关闭
    content: $('#enter_form')
  });

    }
}
function check_year(val) {
    if(val.length>4)return true;
    val = pad_zero(0,val);
    var reg = /^[\d]+$/;
    return !reg.test(val);
}
function check_month(val) {
    if(val.length>2)return true;
    val = pad_zero(1,val);
    var reg = /^[\d]+$/;
    if(!reg.test(val))return true;
    var value_z = parseInt(val);
    if(value_z<1||val>12)return true;
    return false;
}
function check_day(val,month,year) {
    month = parseInt(month);
    year = parseInt(year);
    if(val.length>2)return true;
    val = pad_zero(1,val);
    var reg = /^[\d]+$/;
    if(!reg.test(val))return true;
    var day=[[31,28,31,30,31,30,31,31,30,31,30,31],[31,29,31,30,31,30,31,31,30,31,30,31]];
    if(val<1||val>day[check_run(parseInt(year))][parseInt(month)-1])
        return true;
    return false;

}
function pad_zero(flag,val) {
    var len=4;
    var zero="";
    if(flag==1)len=2;
    for(var i=0;i<len-val.length;i++)
    {
        zero+="0";
    }
    return zero+val;
}
function check_run(year) {
    if(year%4==0&&year%100!=0)
    {
        return 1;
    }
    if(year%400==0)
    {
        return 1;
    }
    return 0;
}
function choose_form(e) {
    if(showflag)
{
    showflag=false;
    return;}
    var index = layer.open({
        skin:"choose_form",
        type: 1,
        title: '选择标注信息类型',
        area: ['230px', '100px'],
        shadeClose: true, //点击遮罩关闭
        btn: ['图片标注','视频标注'],
        btn1: function () {
            type_arr = ["jpg","png","gif","jpeg"];
            marker_type = 1;
            popLayer(e);
            layer.close(index)
        },
        btn2: function () {
            type_arr = ["mp4","rmvb","mkv"];
            marker_type = 2;
            popLayer(e);
            layer.close(index)

        }
    })
}
function video_show() {
        $("#show_img").attr("src","");
        $('#description_value').html("视频说明 :");
        $('#encodetype_value_block').css("display","none");
        $('#source_value').html("视频来源 :");
        $('#up_file').css("display","none");
        $('#video_url_block').css("display","block");
}
function image_show() {
        $('#description_value').html("图片说明 :");
        $('#encodetype_value_block').css("display","block");
        $('#encodetype_value').html("图片格式 :");
        $('#source_value').html("图片来源 :");
        $('#up_file').css("display","block");
        $('#video_url_block').css("display","none");
}
function popLayer(e) {
    clear_form()
    var title_info;
    if(marker_type == 2)
    {
        title_info = "编辑视频标注信息";
        video_show()
    }
    else if(marker_type == 1)
    {
        title_info = "编辑图片标注信息";
        image_show()
    }
    var index = layer.open({
    type: 1,
    title: title_info,
    area: ['350px', '550px'],
    shadeClose: true, //点击遮罩关闭
    content: $('#enter_form'),
    btn:['提交','取消'],
    yes:function () {
        $('.error-msg').html("");
        var flag2 = true;
        var lng = e.point.lng;
        var lat = e.point.lat;
        var up_file = $('#up_file').val();
        var video_url=$('#video_url').val();
        var title = $('#title').val();
        var building_name = $('#building_name').val();
        var building_information = $('#building_information').val();
        var cre_date_year = $('#cre_date_year').val();
        var cre_date_month = $('#cre_date_month').val();
        var cre_date_day = $('#cre_date_day').val();
        var creator = $('#creator').val();
        var date_str = $('#cre_date_str').val();
        var CopyrightOwner = $('#CopyrightOwner').val();
        var file_description = $('#file_description').val();
        var location = $('#location').val();
        var encode_type = $('#encode_type').val();
        var announcer = $('#announcer').val();
        var file_citation = $('#file_citation').val();
        var type = $('#type').val();
        if(marker_type == 1 && isEmpty(up_file))
        {
            $('#up_file_error').html("*选择一个文件!");
            flag2=false;
        }
        if(marker_type == 2 && isEmpty(video_url))
        {
            $('#video_url_error').html("*填写一个视频网址!");
            flag2=false;
        }
        if(isEmpty(building_name))
        {
            building_name = "？"
        }
        if(isEmpty(cre_date_year)&&isEmpty(date_str))
        {
            $('#cre_date_error').html("*时间不能为空!");
            flag2=false;
        }

        if(isEmpty(location))
        {
            $('#location_error').html("*地点不能为空!");
            flag2=false;
        }
        if(isEmpty(building_information))
        {
            building_information ="无"
        }if(isEmpty(file_description))
        {
            file_description = "无"
        }

        if(isEmpty(title))
        {
            $('#title_error').html("*标题不能为空!");
            flag2=false;
        }
        if(isEmpty(creator))
        {
            creator = "佚名"
        }
        if((!isEmpty(cre_date_month)||!isEmpty(cre_date_day))&&isEmpty(cre_date_year))
        {
            $('#cre_date_error').html("*年份不能为空!"); return;
        }
        if(!isEmpty(cre_date_year)&&check_year(cre_date_year))
        {
            console.log("---")
            $('#cre_date_error').html("*日期不合法!");            return;

        }
        if(isEmpty(cre_date_month)&&!isEmpty(cre_date_day))
        {            console.log("---")

            $('#cre_date_error').html("*日期不合法!");           return;

        }
        if(!isEmpty(cre_date_month)&&check_month(cre_date_month))
        {            console.log("---")

            $('#cre_date_error').html("*日期不合法!");           return;

        }
        if(!isEmpty(cre_date_day)&&check_day(cre_date_day,cre_date_month,cre_date_year))
        {            console.log("---")

            $('#cre_date_error').html("*日期不合法!");            return;

        }
        if(flag2)
        {
    var selectedFile=new FormData();
    var cre_date;
    if(isEmpty(cre_date_year))
        cre_date="null";
    else
    {
        cre_date=pad_zero(0,cre_date_year);
        if(!isEmpty(cre_date_month))cre_date=cre_date+"-"+pad_zero(1,cre_date_month);
        if(!isEmpty(cre_date_day))cre_date=cre_date+"-"+pad_zero(1,cre_date_day);
    }
    console.log(cre_date)
    selectedFile.append("up_file",document.getElementById("up_file").files[0]);
    selectedFile.append("lng",lng);
    selectedFile.append("lat",lat);
    selectedFile.append("title",title);
    selectedFile.append("building_name",building_name);
    selectedFile.append("cre_date",cre_date);
    selectedFile.append("cre_date_str",date_str);
    selectedFile.append("building_information",building_information);
    selectedFile.append("creator",creator);
    selectedFile.append("video_url",video_url);
    selectedFile.append("CopyrightOwner",CopyrightOwner);
    selectedFile.append("file_description",file_description);
    selectedFile.append("location",location);
    selectedFile.append("encode_type",encode_type);
    selectedFile.append("announcer",announcer);
    selectedFile.append("file_citation",file_citation);
    selectedFile.append("type",type);
    selectedFile.append("marker_type",marker_type);
    console.log(selectedFile);
    $.ajax({

        async: true,
beforeSend: function () {
            layer.close(index);
            $.ShowLoadDialog();
},
         type: 'post',
        url: '/map/process/',
        cache: false,
        data: selectedFile,
        processData:false,
        contentType:false,
 success: function (result) {
            $.ShowLoadDialogClose();
            layer.alert("标注成功!");
            get_location();
        },
        error:function (){
            $.ShowLoadDialogClose();
            layer.alert("标注失败!")
        }

    });

        }

        },
    no:function(){//取消按钮
            //do something;
        layer.close(index);
        }

  });
    }
//判断字符是否为空的方法
function isEmpty(obj){
    if(typeof obj == "undefined" || obj == null || obj == ""){
        return true;
    }else{
        return false;
    }
}
(function ($) {
        $.extend({
            //弹窗蒙层
            ShowLoadDialog : function () {
                if ($("#divtipmongolia").length <= 0) {
                    var cusrtxt = $("<div id=\"divtipmongolia\" style=\"position:absolute; z-index:6666;background-color:#000000; opacity:0.6; top:0; bottom:0; right:0; left:0;\"></div>").appendTo($("body"));
                    var atexthtml = "<div style=\"margin-top:25%;text-align:center;font-size:13pt;color:#FCE16E\"> <img src=\"../../../static/imgs/loading.gif\" />正在处理...</div>";
                    $("#divtipmongolia").html(atexthtml);
                }
                else {
                    $("#divtipmongolia").css("display", "block");
                }

            },

            //关闭蒙层
            ShowLoadDialogClose: function ()
            {
                if ($("#divtipmongolia").length > 0) { $("#divtipmongolia").css("display", "none"); }
            }
        });
    }
)(jQuery)
function sear(result) {//地图搜索
    var local = new BMap.LocalSearch(map, {
        renderOptions: {map: map}
    });
    local.search(result);
}
function checkFileExt(filename)
{
 var flag = false; //状态
 //取出上传文件的扩展名
 var index = filename.lastIndexOf(".");
 var ext = filename.substr(index+1);
 //循环比较
 for(var i=0;i<type_arr.length;i++)
 {
  if(ext == type_arr[i])
  {
   flag = true; //一旦找到合适的，立即退出循环
   break;
  }
 }
 //条件判断
 if(!flag)
 {
     $("#up_file").val("");
  alert("不支持此类文件！")
 }
 else {
     if(marker_type == 1)
     get_type();
 }
}

function get_type() {
     var file = $("#up_file").val();
 var pos = file.lastIndexOf("\\");
 var filename = file.substring(pos+1);

 var fileextname = filename.substring(filename.lastIndexOf(".")+1, filename.length);
 console.log(fileextname)
 $("#encode_type").val(fileextname)
}

</script>
{% endblock %}