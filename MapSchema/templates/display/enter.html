{% extends 'base.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/address.css' %}">
      <link href="{% static 'css/enter_form.css' %}" rel="stylesheet">

    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=2.0&ak=h40MTWwwSpgwCUEw8MbIiBnc3X4keNgX"></script>
    <script type="text/javascript" src="{% static 'js/3.1.1/layer.js' %}"></script>
{% endblock %}
{% block title %}主页{% endblock %}
{% block content %}


    <div id="enter_form" style="display: none">
   <form  action="" method="post" enctype="multipart/form-data" id="form" class="smart-green" >
{% csrf_token %}
    <input type="file"  required="required" name="up_file" id="up_file" onchange="checkFileExt(this.value)">
               <div id = "up_file_error" class="error-msg"></div>

       <label><span>建筑名称 :</span>
        <input id="building_name" required="required" type="text" name="building_name"  />
        <div id = "building_name_error" class="error-msg"></div>
    </label>
    <label><span>原始标题 :</span>
        <input id="title" required="required" type="text" name="title"  />
        <div id = "title_error" class="error-msg"></div>
    </label>
       <label><span>拍摄者 :</span>
        <input id="creator" type="text" name="creator"  />
        <div id = "creator_error" class="error-msg"></div>
    </label>
       <label><span>拍摄时间 :</span>
        <input id="cre_date_year" required="required" type="text" placeholder="年" name="cre_date_year"  style="display: inline-block;width: 60px;border-radius: 3px"/>
       <input id="cre_date_month" required="required" type="text" placeholder="月" name="cre_date_month"  style="display: inline-block;width: 40px;border-radius: 3px"/>
       <input id="cre_date_day" required="required" type="text" placeholder="日"  name="cre_date_day"  style="display: inline-block;width: 40px;border-radius: 3px"/>
        <div id = "cre_date_error" class="error-msg"></div>
    </label>
       <label><span>地理位置 :</span>
        <input id="location" type="text" name="location"  />
        <div id = "location_error" class="error-msg"></div>
    </label>
       <label><span>图片说明:</span>
        <textarea id="img_description" required="required" name="img_description"></textarea>
        <div id = "img_description_error" class="error-msg"></div>
    </label>
    <label><span>图片格式 :</span>
        <input id="encode_type" required="required" type="text" name="encode_type"  onclick="get_type()"/>
        <div class="error-msg"></div>
    </label>
       <label><span> 建筑现状:</span>
        <textarea id="building_information"  required="required" name="building_information"></textarea>
        <div id = "building_information_error" class="error-msg"></div>
    </label>
       <label><span> 发布者:</span>
        <input id="announcer" type="text" name="announcer"  />
        <div class="error-msg"></div>
    </label>
       <label><span> 版权人:</span>
        <input id="CopyrightOwner" type="text" name="CopyrightOwner"  />
        <div class="error-msg"></div>
    </label>
       <label><span> 图片来源:</span>
        <input id="file_url" type="text" name="file_url"  />
        <div class="error-msg"></div>
    </label>
       <label><span> 分类:</span>
        <input id="type" type="text" name="type" placeholder="可填多个标签(以空格分隔)" />
        <div class="error-msg"></div>
    </label>
    <div class="success-msg"></div>
    <input type="hidden" name="csrfmiddlewaretoken" value="SfHkbL4feo1G00sJQtbO7TtLN4c2BUwa" />
</form>
</div>
 <div  id="show_div" style="display:none;" class="smart-green">
    <img src="" id="show_img" style="width: 350px">
       <p><div class="lab">建筑名称 :</div>
        <span id="show_building_name" class="value"> </span>
    </p>
    <p><div class="lab">原始标题 :</div>
        <span id="show_title" class="value"> </span>
    </p>
       <p><div class="lab">拍摄者 :</div>
       <span id="show_creator" class="value"> </span>
    </p>
       <p><div class="lab">拍摄时间 :</div>
       <span id="show_cre_date" class="value"> </span>
    </p>
       <p><div class="lab">地理位置 :</div>
      <span id="show_location" class="value"> </span>
    </p>
       <p><div class="lab">图片说明:</div>
      <span id="show_img_description" class="value"> </span>
    </p>
    <p><div class="lab">图片格式 :</div>
      <span id="show_encode_type" class="value"> </span>
    </p>
       <p><div class="lab"> 建筑现状:</div>
      <span id="show_building_information" class="value"> </span>
    </p>
       <p><div class="lab"> 发布者:</div>
      <span id="show_announcer" class="value"> </span>
    </p>
       <p><div class="lab"> 版权人:</div>
      <span id="show_CopyrightOwner" class="value"> </span>
    </p>
       <p><div class="lab"> 图片来源:</div>
      <span id="show_file_url" class="value"> </span>
    </p>
       <p><div class="lab"> 分类:</div>
      <span id="show_type" class="value"> </span>
    </p>
 </div>
<form action="" method="get">
<div id="search_block">
  <label style="margin-left: 10px;color: white">地点：</label>
  <input id="where" style="width: 300px;margin-top: 8px;margin-bottom: 5px";name="where" type="text" >
  <input type="button" value="地图上找"  style="margin-right: 10px;" onClick="sear(document.getElementById('where').value);" />
      <label style="color: white">经纬度：</label>
  <input id="lonlat" style="margin-right: 10px" name="lonlat" type="text" >
    <button><a  href="/display/" style="color: #eb9316;text-decoration: none">查看对应的图谱</a></button>
    <button style="position:absolute;right: 0;width: 80px;margin-top: 8px;margin-right: 15px" onClick="javascript:window.history.back();return false;"><img src="../../../static/imgs/back.png" style="height: 20px"></button>

</div>
  <div style="width:100%;height:650px;border:1px solid gray" id="allmap"></div>
  <br />


</form>


<script type="text/javascript">
    // 百度地图API功能
       // 百度地图API功能
    var showflag=false;
    var marker;
    var time = 0;
    var bjh = $("input[name='bjh']").val();
    var sx = $("input[name='sx']").val();
    var sqr = $("input[name='sqr']").val();
    var pointX;
    var pointY;

    var map = new BMap.Map("allmap"); // 创建Map实例

map.setDefaultCursor("crosshair");
    map.centerAndZoom(new BMap.Point(123.471095,41.68383), 17); // 初始化地图,设置中心点坐标和地图级别,****代表经纬度，可以通过http://api.map.baidu.com/lbsapi/creatmap/ 来查看你需要的城市的经纬度

    //添加地图类型控件
    map.addControl(new BMap.MapTypeControl({
        mapTypes : [ BMAP_NORMAL_MAP, BMAP_HYBRID_MAP ]
    }));
    map.setCurrentCity("沈阳"); // 设置地图显示的城市 此项是必须设置的
    map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
    //点击地图并在此添加标记
    //向地图中添加缩放控件
    var ctrlNav = new window.BMap.NavigationControl({
        anchor: BMAP_ANCHOR_TOP_LEFT,
        type: BMAP_NAVIGATION_CONTROL_LARGE
    });
    map.addControl(ctrlNav);
    //向地图中添加缩略图控件
    var ctrlOve = new window.BMap.OverviewMapControl({
        anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
        isOpen: 1
    });
    map.addControl(ctrlOve);
    //向地图中添加比例尺控件
    var ctrlSca = new window.BMap.ScaleControl({
        anchor: BMAP_ANCHOR_BOTTOM_LEFT
    });
    map.addControl(ctrlSca);
    map.addEventListener("click", function(e) {//鼠标单击地图触发
        if (time >= 1) {
            return;
        } else {

            popLayer(e);
        }
    });
map.addEventListener("mousemove", function(e) {//鼠标单击地图触发
        fill_lonlat(e);
    });
$(function() {
        get_location();
        })
     function get_location() {
    var post_data = "";
    var receive_data="";
    var address_latitude ="";
    var address_longitude ="";
    var address_data ="";
        $.ajax({
                url: '/map/get_points/',
                type: "POST",
                data: post_data,
                success: function (data) {
                    receive_data = JSON.parse(data);
                    address_latitude =receive_data["address_latitude"];
        address_longitude =receive_data["address_longitude"];
        address_data =receive_data["address_data"];
        console.log(receive_data)
                for (var i = 0; i < address_longitude.length; i++) {
            var point = new BMap.Point(parseFloat(address_longitude[i]), parseFloat(address_latitude[i])); //循环生成新的地图点
            createMarker(point,address_data[i])
        }

                },
                error:function () {
                  alert("获取失败！")
                }
             });

    }
function fill_lonlat(e) {
    	$('#lonlat').val(e.point.lng + ", " + e.point.lat);

}
function createMarker(point,point_data) {
    user_id = {{ request.session.user_id }}
    var marker = new BMap.Marker(point, {
  // 初始化五角星symbol
  icon: new BMap.Symbol(BMap_Symbol_SHAPE_STAR, {
    scale: 1,
    fillColor: "yellow",
    fillOpacity: 0.8
  })
});
    if(user_id == point_data["monitor_id"])
    {
        marker = new BMap.Marker(point, {
  // 初始化五角星symbol
  icon: new BMap.Symbol(BMap_Symbol_SHAPE_STAR, {
    scale: 1,
    fillColor: "red",
    fillOpacity: 0.8
  })
});
    }

    map.addOverlay(marker);
    marker.addEventListener('click', function () {
        showInfo(this,point_data);
    });
}
function showInfo(thisMarker,point_info) {
    user_id = {{ request.session.user_id }}
    user_role  = '{{ request.session.role }}'
    showflag=true;
    for(var i in point_info)
    {
        var str=point_info[i][0];
        if(i == "building_name")str=str.slice(0,-2)
        for(var j=1;j<point_info[i].length;j++)
        {
            str = str + " " + point_info[i][j];
            if(i == "building_name")str=str.slice(0,-2)
        }
        $('#'+"show_"+i).text(str)
    }
    $("#show_img").attr("src","..\\..\\..\\"+point_info["img"][0]);
    if(user_id == point_info["monitor_id"] || user_role == "A")
    {
        var index = layer.open({
    type: 1,
    title: '标注信息',
    area: ['500px', '750px'],
    shadeClose: true, //点击遮罩关闭
    content: $('#show_div'),
     btn:['删除该标注点'],
     btn1:function () {
            var post_data ={ "node_id":point_info["node_id"]};
            console.log(post_data)
        $.ajax({
                url: '/map/delete_point/',
                type: "POST",
                data: post_data,
                async: true,
                success: function (data) {
                    layer.alert("已删除！")
                    map.removeOverlay(thisMarker);
                    layer.close(index);
                },
                error:function () {
                  layer.alert("删除失败！")
                }
             });
     }
  });

    }
    else
    {
     var index = layer.open({
    type: 1,
    title: '标注信息',
    area: ['500px', '750px'],
    shadeClose: true, //点击遮罩关闭
    content: $('#show_div')
  });

    }
}
function check_year(val) {
    console.log(val,typeof val,val.length)
    var zero="";
    if(val.length>4)return true;
    val = pad_zero(0,val);
    var reg = /^[\d]+$/;
    return !reg.test(val);
}
function check_month(val) {
    var zero="";
    if(val.length>2)return true;
    val = pad_zero(1,val);
    var reg = /^[\d]+$/;
    if(!reg.test(val))return true;
    var value_z = parseInt(val);
    if(value_z<1||val>12)return true;
    return false;
}
function check_day(val,month,year) {
    var zero="";
    month = parseInt(month);
    year = parseInt(year);
    if(val.length>2)return true;
    val = pad_zero(1,val);
    var reg = /^[\d]+$/;
    if(!reg.test(val))return true;
    var day=[[31,28,31,30,31,30,31,31,30,31,30,31],[31,29,31,30,31,30,31,31,30,31,30,31]];
    if(val<1||val>day[check_run(parseInt(year))][parseInt(month)-1])
        return true;
    return false;

}
function pad_zero(flag,val) {
    var len=4;
    var zero="";
    if(flag==1)len=2;
    for(var i=0;i<len-val.length;i++)
    {
        zero+="0";
    }
    return zero+val;
}
function check_run(year) {
    if(year%4==0&&year%100!=0)
    {
        return 1;
    }
    if(year%400==0)
    {
        return 1;
    }
    return 0;
}
function popLayer(e) {
    console.log(e.point)
if(showflag)
{
    showflag=false;
    return;}
    document.getElementById('form').reset();
    var index = layer.open({
    type: 1,
    title: '编辑标注信息',
    area: ['550px', '650px'],
    shadeClose: true, //点击遮罩关闭
    content: $('#enter_form'),
    btn:['提交','取消'],
    yes:function () {
        $('.error-msg').html("");
        var flag2 = true;
        var lng = e.point.lng;
        var lat = e.point.lat;
        var up_file = $('#up_file').val();
        var title = $('#title').val();
        var building_name = $('#building_name').val();
        var building_information = $('#building_information').val();
        var cre_date_year = $('#cre_date_year').val();
        var cre_date_month = $('#cre_date_month').val();
        var cre_date_day = $('#cre_date_day').val();
        var creator = $('#creator').val();
        var CopyrightOwner = $('#CopyrightOwner').val();
        var img_description = $('#img_description').val();
        var location = $('#location').val();
        var encode_type = $('#encode_type').val();
        var announcer = $('#announcer').val();
        var file_url = $('#file_url').val();
        var type = $('#type').val();
        if(isEmpty(up_file))
        {
            $('#up_file_error').html("选择一个文件!");
            flag2=false;
        }
        if(isEmpty(building_name))
        {
            building_name = "？"
        }
        if(isEmpty(cre_date_year))
        {
            $('#cre_date_error').html("年份不能为空!");
            flag2=false;
        }
        if(isEmpty(location))
        {
            $('#location_error').html("地点不能为空!");
            flag2=false;
        }
        if(isEmpty(building_information))
        {
            building_information ="无"
        }if(isEmpty(img_description))
        {
            img_description = "无"
        }

        if(isEmpty(title))
        {
            $('#title_error').html("标题不能为空!");
            flag2=false;
        }
        if(isEmpty(creator))
        {
            creator = "佚名"
        }
        if(!isEmpty(cre_date_year)&&check_year(cre_date_year))
        {
            $('#cre_date_error').html("日期不合法!");            return;

        }
        if(isEmpty(cre_date_month)&&!isEmpty(cre_date_day))
        {
            $('#cre_date_error').html("日期不合法!");           return;

        }
        if(!isEmpty(cre_date_month)&&check_month(cre_date_month))
        {
            $('#cre_date_error').html("日期不合法!");           return;

        }
        if(!isEmpty(cre_date_day)&&check_day(cre_date_day,cre_date_month,cre_date_year))
        {
            $('#cre_date_error').html("日期不合法!");            return;

        }
        if(flag2)
        {
    var selectedFile=new FormData();
    var cre_date=pad_zero(0,cre_date_year);
     if(!isEmpty(cre_date_month))cre_date=cre_date+"-"+pad_zero(1,cre_date_month);
    if(!isEmpty(cre_date_day))cre_date=cre_date+"-"+pad_zero(1,cre_date_day);
    console.log(cre_date)
    selectedFile.append("up_file",document.getElementById("up_file").files[0]);
    selectedFile.append("lng",lng);
    selectedFile.append("lat",lat);
    selectedFile.append("title",title);
    selectedFile.append("building_name",building_name);
    selectedFile.append("cre_date",cre_date);
    selectedFile.append("building_information",building_information);selectedFile.append("creator",creator);
    selectedFile.append("CopyrightOwner",CopyrightOwner);selectedFile.append("img_description",img_description);
    selectedFile.append("location",location);selectedFile.append("encode_type",encode_type);
    selectedFile.append("announcer",announcer);
    selectedFile.append("file_url",file_url);selectedFile.append("type",type);
    console.log(selectedFile)
    $.ajax({

        async: true,
beforeSend: function () {
            layer.close(index);
            $.ShowLoadDialog();
},
         type: 'post',
        url: '/map/process/',
        cache: false,
        data: selectedFile,
        processData:false,
        contentType:false,
 success: function (result) {
            $.ShowLoadDialogClose();
            layer.alert("标注成功!")
            get_location();
        },
        error:function (){
            layer.alert("标注失败!")
        }

    });

        }

        },
    no:function(){//取消按钮
            //do something;
        layer.close(index);
        }

  });
    }
//判断字符是否为空的方法
function isEmpty(obj){
    if(typeof obj == "undefined" || obj == null || obj == ""){
        return true;
    }else{
        return false;
    }
}
(function ($) {
        $.extend({
            //弹窗蒙层
            ShowLoadDialog : function () {
                if ($("#divtipmongolia").length <= 0) {
                    var cusrtxt = $("<div id=\"divtipmongolia\" style=\"position:absolute; z-index:6666;background-color:#000000; opacity:0.6; top:0; bottom:0; right:0; left:0;\"></div>").appendTo($("body"));
                    var atexthtml = "<div style=\"margin-top:25%;text-align:center;font-size:13pt;color:#FCE16E\"> <img src=\"../../../static/imgs/loading.gif\" />正在处理...</div>";
                    $("#divtipmongolia").html(atexthtml);
                }
                else {
                    $("#divtipmongolia").css("display", "block");
                }

            },

            //关闭蒙层
            ShowLoadDialogClose: function ()
            {
                if ($("#divtipmongolia").length > 0) { $("#divtipmongolia").css("display", "none"); }
            }
        });
    }
)(jQuery)
function sear(result) {//地图搜索
    var local = new BMap.LocalSearch(map, {
        renderOptions: {map: map}
    });
    local.search(result);
}
function checkFileExt(filename)
{
 var flag = false; //状态
 var arr = ["jpg","png","gif","jpeg","mp4","rmvb","mkv"];
 //取出上传文件的扩展名
 var index = filename.lastIndexOf(".");
 var ext = filename.substr(index+1);
 //循环比较
 for(var i=0;i<arr.length;i++)
 {
  if(ext == arr[i])
  {
   flag = true; //一旦找到合适的，立即退出循环
   break;
  }
 }
 //条件判断
 if(!flag)
 {
     $("#up_file").val("")
  alert("不支持此类文件！")
 }
}

function get_type() {
     var file = $("#up_file").val();
 var pos = file.lastIndexOf("\\");
 var filename = file.substring(pos+1);

 var fileextname = filename.substring(filename.lastIndexOf(".")+1, filename.length);
 console.log(fileextname)
 $("#encode_type").val(fileextname)
}

</script>
{% endblock %}